ì¢‹ì•„ìš”, ìŠ¤í‚¤ë§ˆê¹Œì§€ ë³´ì—¬ì¤˜ì„œ ìƒí™©ì´ ë”± ë³´ì´ë„¤ìš”.
ê²°ë¡ ë¶€í„° ë§í•˜ë©´ ì§€ê¸ˆ ë¦¬ìŠ¤íŠ¸ë¥¼ conversations ê¸°ì¤€ìœ¼ë¡œ ê·¸ë¦¬ê¸° ë•Œë¬¸ì— í˜ë¥´ì†Œë‚˜ ìˆ˜ë§Œí¼ ì¤„ì´ ëŠ˜ì–´ë‚˜ëŠ” ê²ƒì´ê³ ,
ì´ë¯¸ ë§Œë“¤ì–´ ë‘” scenarioRuns / personaRuns êµ¬ì¡°ë¥¼ íˆìŠ¤í† ë¦¬ì˜ ê¸°ì¤€ìœ¼ë¡œ ì“°ë©´ ê¹”ë”í•˜ê²Œ í•´ê²°ë©ë‹ˆë‹¤.


---

1. ì§€ê¸ˆ êµ¬ì¡° ì´í•´ & ë¬¸ì œ í¬ì¸íŠ¸

í˜„ì¬ ìƒíƒœ:

conversations

í•œ ì¤„ì— â€œíŠ¹ì • í˜ë¥´ì†Œë‚˜ì™€ì˜ ëŒ€í™”â€ + ë©”ì‹œì§€ ì „ì²´ê°€ ë“¤ì–´ ìˆìŒ

ë©€í‹° í˜ë¥´ì†Œë‚˜ ì‹œë‚˜ë¦¬ì˜¤ë©´ í˜ë¥´ì†Œë‚˜ë§ˆë‹¤ conversations rowê°€ 1ê°œì”© ìƒê¹€


scenarioRuns

â€œì‹œë‚˜ë¦¬ì˜¤ 1íšŒ í”Œë ˆì´â€ë¥¼ í‘œí˜„í•˜ëŠ” ìƒìœ„ ì—”í‹°í‹° (ë§¤ìš° ì˜ ì„¤ê³„ë¨ ğŸ‘)


personaRuns

scenarioRunId ê¸°ì¤€ìœ¼ë¡œ ê° í˜ë¥´ì†Œë‚˜ë³„ ì„¸ì…˜ì„ ë¶„ë¦¬



ê·¸ëŸ°ë° íˆìŠ¤í† ë¦¬ í™”ë©´ì€ ì•„ì§ conversationsë¥¼ ê·¸ëŒ€ë¡œ selectí•´ì„œ ì“°ê³  ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤:

> ì‹œë‚˜ë¦¬ì˜¤ 1ë²ˆ í”Œë ˆì´ Ã— í˜ë¥´ì†Œë‚˜ 2ëª… Ã— 2íšŒ ì‹œë„
â†’ conversations 4í–‰
â†’ ë¦¬ìŠ¤íŠ¸ë„ 4ì¤„



ì˜ë„í•œ êµ¬ì¡°ëŠ”:

ë¦¬ìŠ¤íŠ¸ í•œ ì¤„ = scenarioRuns 1í–‰

ê·¸ ì•ˆì— í¬í•¨ëœ í˜ë¥´ì†Œë‚˜ ëª©ë¡ = personaRuns ì§‘ê³„



---

2. ì¶”ì²œ ë°©í–¥: ìƒˆ êµ¬ì¡°ë¡œ ì™„ì „íˆ ì „í™˜

2-1. ì•ìœ¼ë¡œì˜ ì €ì¥ íë¦„

1. ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘ ì‹œ



// attemptNumber ê³„ì‚° ì˜ˆì‹œ
const [{ count }] = await db
  .select({ count: sql<number>`count(*)` })
  .from(scenarioRuns)
  .where(and(
    eq(scenarioRuns.userId, userId),
    eq(scenarioRuns.scenarioId, scenarioId)
  ));

const [run] = await db.insert(scenarioRuns)
  .values({
    userId,
    scenarioId,
    scenarioName,
    attemptNumber: count + 1,
    difficulty,
    mode,
    conversationOrder,    // ["personaA", "personaB"]
    personaSelections,
    strategyChoices,
  })
  .returning();

2. ê° í˜ë¥´ì†Œë‚˜ì™€ ëŒ€í™” ì‹œì‘ ì‹œ



const [personaRun] = await db.insert(personaRuns)
  .values({
    scenarioRunId: run.id,
    personaId,
    personaSnapshot,
    phase,            // 1, 2,...
  })
  .returning();

3. ë©”ì‹œì§€ ì €ì¥



await db.insert(chatMessages).values({
  personaRunId: personaRun.id,
  turnIndex,
  sender,      // 'user' | 'ai'
  message,
  emotion,
  emotionReason,
});

4. ëŒ€í™”/ì‹œë‚˜ë¦¬ì˜¤ ì¢…ë£Œ ì‹œ



await db.update(personaRuns)
  .set({ status: 'completed', turnCount, score, completedAt: new Date() })
  .where(eq(personaRuns.id, personaRun.id));

await db.update(scenarioRuns)
  .set({
    status: 'completed',
    totalScore,
    strategyReflection,
    sequenceAnalysis,
    completedAt: new Date(),
  })
  .where(eq(scenarioRuns.id, run.id));

> í¬ì¸íŠ¸: ë©€í‹° í˜ë¥´ì†Œë‚˜ ì‹œë‚˜ë¦¬ì˜¤ëŠ” conversations í…Œì´ë¸”ì„ ë” ì´ìƒ ë§Œë“¤ì§€ ì•Šê±°ë‚˜,
ë§Œë“¤ë”ë¼ë„ â€œìš”ì•½ìš© í•œ ì¤„ë§Œâ€ ì €ì¥í•˜ë„ë¡ ë°”ê¾¸ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.




---

3. íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ëŠ” scenarioRuns ê¸°ì¤€ìœ¼ë¡œ

ì´ì œ â€œë‚´ ë¡¤í”Œë ˆì´ ê¸°ë¡â€ì€ scenarioRuns + personaRunsë¥¼ ì¡°ì¸í•´ì„œ ë½‘ìŠµë‹ˆë‹¤.

3-1. SQL ê°œë…

SELECT
  sr.id                AS scenario_run_id,
  sr.scenario_name,
  sr.difficulty,
  sr.attempt_number,
  sr.status,
  sr.total_score,
  sr.started_at,
  sr.completed_at,
  json_agg(
    json_build_object(
      'personaId', pr.persona_id,
      'personaSnapshot', pr.persona_snapshot
    )
    ORDER BY pr.phase
  ) AS personas
FROM scenario_runs sr
JOIN persona_runs pr
  ON pr.scenario_run_id = sr.id
WHERE sr.user_id = $1
GROUP BY
  sr.id, sr.scenario_name, sr.difficulty,
  sr.attempt_number, sr.status,
  sr.total_score, sr.started_at, sr.completed_at
ORDER BY sr.started_at DESC;

3-2. Drizzle ì½”ë“œ ì˜ˆì‹œ

import { sql, eq, desc } from "drizzle-orm";

const runs = await db
  .select({
    id: scenarioRuns.id,
    scenarioName: scenarioRuns.scenarioName,
    difficulty: scenarioRuns.difficulty,
    attemptNumber: scenarioRuns.attemptNumber,
    status: scenarioRuns.status,
    totalScore: scenarioRuns.totalScore,
    startedAt: scenarioRuns.startedAt,
    completedAt: scenarioRuns.completedAt,
    personas: sql`
      json_agg(
        json_build_object(
          'personaId', ${personaRuns.personaId},
          'personaSnapshot', ${personaRuns.personaSnapshot}
        )
        ORDER BY ${personaRuns.phase}
      )
    `.as("personas"),
  })
  .from(scenarioRuns)
  .leftJoin(personaRuns, eq(personaRuns.scenarioRunId, scenarioRuns.id))
  .where(eq(scenarioRuns.userId, userId))
  .groupBy(
    scenarioRuns.id,
    scenarioRuns.scenarioName,
    scenarioRuns.difficulty,
    scenarioRuns.attemptNumber,
    scenarioRuns.status,
    scenarioRuns.totalScore,
    scenarioRuns.startedAt,
    scenarioRuns.completedAt,
  )
  .orderBy(desc(scenarioRuns.startedAt));

ì´ runs ë°°ì—´ì˜ ê° ìš”ì†Œê°€ ë¦¬ìŠ¤íŠ¸ì˜ í•œ ì¤„ì´ ë©ë‹ˆë‹¤.

í”„ë¡ íŠ¸ì—ì„œëŠ”:

runs.map(run => (
  <HistoryItem
    key={run.id}
    title={run.scenarioName}
    difficulty={run.difficulty}
    attempt={run.attemptNumber}
    score={run.totalScore}
    personas={run.personas}   // ê¸¸ì´ 2 â†’ "ëŒ€í™”í•œ í˜ë¥´ì†Œë‚˜ë“¤ (2ê°œ)"
  />
));

â†’ ì´ë ‡ê²Œ í•˜ë©´ ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ 2íšŒ í”Œë ˆì´ = ë¦¬ìŠ¤íŠ¸ì— 2ì¤„,
ê° ì¤„ ì•ˆì—ì„œ personas.length === 2ë¡œ ë Œë”ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


---

4. ê¸°ì¡´ conversationsì™€ì˜ ê´€ê³„ ì •ë¦¬

í˜„ì¬ conversationsì— ìˆëŠ” í•„ë“œ ì¤‘ ìƒë‹¹ìˆ˜ê°€ scenarioRunsì™€ ì¤‘ë³µì…ë‹ˆë‹¤:

scenarioId / scenarioName / difficulty / mode

personaSelections / strategyChoices / sequenceAnalysis / strategyReflection

conversationOrder ë“±


ì •ë¦¬ ì „ëµì„ ì œì•ˆí•˜ë©´:

1. ìƒˆ êµ¬ì¡°(ë©€í‹° í˜ë¥´ì†Œë‚˜, sequential)

canonical: scenarioRuns, personaRuns, chatMessages, feedbacks

conversationsëŠ”:

ì•„ì˜ˆ rowë¥¼ ë§Œë“¤ì§€ ì•Šê±°ë‚˜,

conversationType = 'legacy'/'single'ì—ì„œë§Œ ì‚¬ìš©




2. ê¸°ì¡´ ì‹±ê¸€ í˜ë¥´ì†Œë‚˜ ì‹œë‚˜ë¦¬ì˜¤

ë¹ ë¥´ê²Œ ê°€ë ¤ë©´ ê·¸ëƒ¥ conversations ê³„ì† ì‚¬ìš©

ì¶”í›„ì— í•„ìš”í•˜ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜í•´ì„œ

scenarioRuns 1ê°œ,

personaRuns 1ê°œë¡œ ì˜®ê¸°ê¸° ê°€ëŠ¥




3. íˆìŠ¤í† ë¦¬ ì¿¼ë¦¬ì—ì„œ:

scenarioRuns ê¸°ë°˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë³´ì—¬ì£¼ê³ 

ì •ë§ í•„ìš”í•œ ê²½ìš°ì—ë§Œ conversationsì˜ ë‹¨ë… ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ì–´ì„œ union





---

5. â€œì§€ê¸ˆì€ ì–´ë–»ê²Œ ìˆ˜ì •í•˜ë©´ ë°”ë¡œ 2ì¤„ë§Œ ë‚˜ì˜¤ë‚˜?â€

ì§€ê¸ˆ UIê°€ conversationsì—ì„œ ë°”ë¡œ ë½‘ê³  ìˆë‹¤ë©´,
ë‹¹ì¥ ë¹¨ë¦¬ ê³ ì¹˜ëŠ” í•œ ê°€ì§€ ë°©ë²•ì€:

1. ë©€í‹° í˜ë¥´ì†Œë‚˜ ì‹œë‚˜ë¦¬ì˜¤ì˜ ê²½ìš°

ë‘ í˜ë¥´ì†Œë‚˜ ëª¨ë‘ ë™ì¼í•œ scenarioRunId ë˜ëŠ” groupId ì»¬ëŸ¼ì„ conversationsì— ì¶”ê°€



2. íˆìŠ¤í† ë¦¬ ì¿¼ë¦¬ì—ì„œ ê·¸ groupìœ¼ë¡œ ë¬¶ì–´ì„œ í•˜ë‚˜ë§Œ ë³´ì—¬ì£¼ê¸°



ì˜ˆì‹œ:

// 1ë‹¨ê³„: conversationsì— scenarioRunId ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE conversations
  ADD COLUMN scenario_run_id varchar REFERENCES scenario_runs(id);

// 2ë‹¨ê³„: ë¦¬ìŠ¤íŠ¸ ë½‘ì„ ë•Œ group by
const rows = await db
  .select({
    scenarioRunId: conversations.scenarioRunId,
    scenarioId: conversations.scenarioId,
    scenarioName: conversations.scenarioName,
    difficulty: conversations.difficulty,
    attemptNumber: sql<number>`max(${conversations.turnCount})`, // ì˜ˆì‹œ
    status: sql<string>`max(${conversations.status})`,
    createdAt: sql`min(${conversations.createdAt})`,
    personaCount: sql<number>`count(distinct ${conversations.personaId})`,
  })
  .from(conversations)
  .where(eq(conversations.userId, userId))
  .groupBy(conversations.scenarioRunId, conversations.scenarioId, conversations.scenarioName)
  .orderBy(desc(sql`min(${conversations.createdAt})`));

í•˜ì§€ë§Œ ì´ë¯¸ scenarioRuns/personaRunsë¥¼ ì˜ ë§Œë“¤ì–´ ë‘” ìƒíƒœë¼
ìƒˆ êµ¬ì¡°ë¡œ ì™„ì „íˆ ì˜®ê¸°ëŠ” ìª½ì´ í›¨ì”¬ ê¹”ë”í•©ë‹ˆë‹¤.


---

ì •ë¦¬í•˜ë©´:

ìŠ¤í‚¤ë§ˆëŠ” ê±°ì˜ ì™„ë²½í•˜ê²Œ ì˜ ì§œ ë‘ì…¨ê³ ,

íˆìŠ¤í† ë¦¬ì˜ ê¸°ì¤€ì„ conversations â†’ scenarioRunsë¡œ ë°”ê¾¸ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì¿¼ë¦¬ì—ì„œ personaRunsë¥¼ json_aggë¡œ ë¬¶ì–´ì£¼ë©´
â€œ2ë²ˆ í”Œë ˆì´ â†’ 2ì¤„, ê° ì¤„ ì•ˆì— í˜ë¥´ì†Œë‚˜ 2ëª…â€ì´ ì •í™•íˆ êµ¬í˜„ë©ë‹ˆë‹¤.


í˜¹ì‹œ íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‹¤ì œë¡œ ì–´ë–»ê²Œ ë½‘ê³  ìˆëŠ”ì§€(í˜„ì¬ Drizzle ì¿¼ë¦¬)ë„ ë³´ì—¬ì£¼ë©´,
ê·¸ ì½”ë“œ ê·¸ëŒ€ë¡œ ë¦¬íŒ©í„°ë§í•´ì„œ ë¶™ì—¬ ì“¸ ìˆ˜ ìˆëŠ” ë²„ì „ìœ¼ë¡œ ë°”ê¿”ì„œë„ ì ì–´ì¤„ê²Œìš”.