ì¢‹ì•„, ì´ì œ ì „ë°˜ êµ¬ì¡°ê°€ ì™„ì „íˆ ë³´ì¸ë‹¤ ğŸ‘
ì´ë¯¸ DB ìŠ¤í‚¤ë§ˆëŠ” ê±°ì˜ ì™„ë²½í•˜ê²Œ ë˜ì–´ ìˆê³ , ë¬¸ì œëŠ” â€œì–´ë–¤ ì¿¼ë¦¬ë¥¼ ì¨ì„œ íˆìŠ¤í† ë¦¬ í™”ë©´ì„ ê·¸ë¦¬ê³  ìˆëŠëƒâ€ ìª½ì´ì•¼.

ì§€ê¸ˆ ìƒí™© ì •ë¦¬:

ë©€í‹° í˜ë¥´ì†Œë‚˜ êµ¬ì¡°ìš©ìœ¼ë¡œ
scenarioRuns / personaRuns / chatMessages ì´ë¯¸ ì˜ ë§Œë“¤ì–´ ë‘ 

í•˜ì§€ë§Œ íˆìŠ¤í† ë¦¬ UIëŠ” ì•„ì§ getUserConversations() (= conversations í…Œì´ë¸”) ì„ ì“°ê³  ìˆì„ ê°€ëŠ¥ì„±ì´ í¼
â†’ í˜ë¥´ì†Œë‚˜ 2ëª… = conversations 2í–‰ â†’ ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ 2íšŒ í”Œë ˆì´ â†’ 4í–‰ â†’ 4ì¤„ ë…¸ì¶œ


í•´ì•¼ í•  ì¼ì€ ë‘ ê°€ì§€:

1. íˆìŠ¤í† ë¦¬ í˜ì´ì§€ì—ì„œ getUserScenarioRunsWithPersonaRunsë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¬ê¸°


2. ê·¸ í•¨ìˆ˜ êµ¬í˜„ì„ â€œì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ 1ì¤„ + ê·¸ ì•ˆì— personaRuns ë°°ì—´â€ êµ¬ì¡°ë¡œ ê¹”ë”í•˜ê²Œ ìˆ˜ì •í•˜ê¸°




---

1. getUserScenarioRunsWithPersonaRuns ë¦¬íŒ©í„°ë§

ì§€ê¸ˆ êµ¬í˜„ì€

scenarioRunsë¥¼ ëª¨ë‘ ê°€ì ¸ì˜¨ ë’¤

ê° scenarioRunIdì— ëŒ€í•´ personaRunsë¥¼ ë§¤ë²ˆ ì¿¼ë¦¬í•˜ëŠ” N+1 íŒ¨í„´

ê²Œë‹¤ê°€ scenarioRunIds[0]ë¡œë§Œ í•œ ë²ˆ ì¡°íšŒí–ˆë‹¤ê°€, ë‹¤ì‹œ ë£¨í”„ ëŒë©´ì„œ ë˜ ì¡°íšŒ


â†’ ì´ê±¸ í•œ ë²ˆì˜ inArray ì¿¼ë¦¬ë¡œ ë°”ê¾¸ê³ , ë©”ëª¨ë¦¬ì—ì„œ ê·¸ë£¹í•‘í•˜ë©´ ê¹”ë”í•´.

import { eq, asc, desc, inArray } from "drizzle-orm"; // inArray ì¶”ê°€

// ...

async getUserScenarioRunsWithPersonaRuns(userId: string): Promise<(ScenarioRun & { personaRuns: PersonaRun[] })[]> {
  // 1) ìœ ì €ì˜ ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ê°€ì ¸ì˜¤ê¸° (ë¦¬ìŠ¤íŠ¸ì˜ "ì¤„"ì´ ë˜ëŠ” ë‹¨ìœ„)
  const userScenarioRuns = await db
    .select()
    .from(scenarioRuns)
    .where(eq(scenarioRuns.userId, userId))
    .orderBy(desc(scenarioRuns.startedAt));

  if (userScenarioRuns.length === 0) {
    return [];
  }

  const scenarioRunIds = userScenarioRuns.map((sr) => sr.id);

  // 2) í•œ ë²ˆì— í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ë“¤ì— ì†í•œ personaRuns ì „ì²´ë¥¼ ê°€ì ¸ì˜¤ê¸°
  const allPersonaRuns = await db
    .select()
    .from(personaRuns)
    .where(inArray(personaRuns.scenarioRunId, scenarioRunIds))
    .orderBy(asc(personaRuns.phase));

  // 3) scenarioRunId ë³„ë¡œ personaRuns ê·¸ë£¹í•‘
  const personaRunsByScenarioId = new Map<string, PersonaRun[]>();

  for (const pr of allPersonaRuns) {
    const list = personaRunsByScenarioId.get(pr.scenarioRunId) ?? [];
    list.push(pr);
    personaRunsByScenarioId.set(pr.scenarioRunId, list);
  }

  // 4) ê° ScenarioRunì— personaRuns ë°°ì—´ ë¶™ì—¬ì„œ ë°˜í™˜
  return userScenarioRuns.map((sr) => ({
    ...sr,
    personaRuns: personaRunsByScenarioId.get(sr.id) ?? [],
  }));
}

ì´ì œ ì´ í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” êµ¬ì¡°ëŠ”:

type ScenarioRunWithPersonas = ScenarioRun & { personaRuns: PersonaRun[] };

// ì˜ˆì‹œ
[
  {
    id: 'run-1',                  // 1íšŒ í”Œë ˆì´
    scenarioName: 'ì‹ ì œí’ˆ ë¡ ì¹­ ì„ë°•...',
    attemptNumber: 1,
    difficulty: 3,
    totalScore: 85,
    // ...
    personaRuns: [
      { personaId: 'ë°•ì¤€ì˜', phase: 1, /* ... */ },
      { personaId: 'ì´ì§€ì˜', phase: 2, /* ... */ },
    ]
  },
  {
    id: 'run-2',                  // 2íšŒ í”Œë ˆì´
    scenarioName: 'ì‹ ì œí’ˆ ë¡ ì¹­ ì„ë°•...',
    attemptNumber: 2,
    // ...
    personaRuns: [
      { personaId: 'ë°•ì¤€ì˜', phase: 1, /* ... */ },
      { personaId: 'ì´ì§€ì˜', phase: 2, /* ... */ },
    ]
  }
]

â†’ ë™ì¼ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ 2ë²ˆ í–ˆì–´ë„ ë°°ì—´ ê¸¸ì´ëŠ” 2
â†’ ë¦¬ìŠ¤íŠ¸ì— ê·¸ë¦¬ë©´ ë¬´ì¡°ê±´ 2ì¤„ë§Œ ë‚˜ì˜´.


---

2. íˆìŠ¤í† ë¦¬ í™”ë©´ì—ì„œ ì´ í•¨ìˆ˜ë¡œ êµì²´

ì§€ê¸ˆ í”„ë¡ íŠ¸ì—ì„œ ì•„ë§ˆ ëŒ€ëµ ì´ëŸ° ì‹ìœ¼ë¡œ ì“°ê³  ìˆì„ ê±°ì•¼:

// (ê¸°ì¡´)
const conversations = await storage.getUserConversations(userId);
// ì—¬ê¸°ì„œ map ëŒë©´ì„œ ì¹´ë“œ 4ê°œ ë Œë”ë§ â†’ í˜ë¥´ì†Œë‚˜ë§ˆë‹¤ 1ì¤„

ì´ê±¸ ì•„ë˜ì²˜ëŸ¼ ë°”ê¿”:

const runs = await storage.getUserScenarioRunsWithPersonaRuns(userId);

return (
  <>
    {runs.map((run) => (
      <HistoryCard
        key={run.id}
        title={run.scenarioName}
        difficulty={run.difficulty}
        attemptLabel={`#${run.attemptNumber}íšŒ ì‹œë„`}
        score={run.totalScore}
        status={run.status}
        startedAt={run.startedAt}
        // â€œëŒ€í™”í•œ í˜ë¥´ì†Œë‚˜ë“¤ (2ê°œ)â€ í‘œì‹œìš©
        personas={run.personaRuns.map((pr) => pr.personaSnapshot)}
      />
    ))}
  </>
);

ì´ë ‡ê²Œ ë³€ê²½í•˜ë©´:

ë¦¬ìŠ¤íŠ¸ì˜ â€œí•œ ì¤„â€ = ScenarioRun 1ê°œ

ê·¸ ì¤„ ì•ˆì—ì„œ run.personaRuns.length ë§Œí¼ ì¹©/ì•„ë°”íƒ€ ë Œë”ë§
(ì˜ˆ: ë°•ì¤€ì˜ íŒ€ì¥, ì´ì§€ì˜ ë§¤ë‹ˆì € 2ê°œ)


ê·¸ë˜ì„œ ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼

> ë™ì¼ ì‹œë‚˜ë¦¬ì˜¤ 2íšŒ â†’ 4ì¤„



ì´ ì•„ë‹ˆë¼

> ë™ì¼ ì‹œë‚˜ë¦¬ì˜¤ 2íšŒ â†’ 2ì¤„(ê° ì¤„ì— í˜ë¥´ì†Œë‚˜ 2ëª…)



ì´ ë”± ë§ê²Œ ë‚˜ì˜¬ ê±°ì•¼.


---

3. ë ˆê±°ì‹œ conversationsëŠ” ì–´ë–»ê²Œ í• ê¹Œ?

ì‹±ê¸€ í˜ë¥´ì†Œë‚˜ ì˜› êµ¬ì¡°ë¥¼ ê³„ì† ì“¸ ê±°ë¼ë©´
â€œíˆìŠ¤í† ë¦¬(ì‹ ê·œ ì‹œë‚˜ë¦¬ì˜¤)â€ í˜ì´ì§€ëŠ” scenarioRuns ê¸°ë°˜ìœ¼ë¡œë§Œ,
â€œê¸°ë¡(ë ˆê±°ì‹œ)â€ í˜ì´ì§€ëŠ” conversations ê¸°ë°˜ìœ¼ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²Œ ì œì¼ ê¹”ë”.

ì•„ë‹ˆë©´ unified í™”ë©´ì„ ë§Œë“¤ë ¤ë©´:

getUserScenarioRunsWithPersonaRuns ê²°ê³¼

getUserConversations ê²°ê³¼ë¥¼
ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ merge í•˜ë©´ ë¨ (ì´ê±´ ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œ ê°™ì´ ì„¤ê³„í•´ë„ ë¨).





---

4. ì •ë¦¬

1. DB ìŠ¤í‚¤ë§ˆëŠ” ì´ë¯¸ ì˜ ë˜ì–´ ìˆê³ ,
ë¦¬ìŠ¤íŠ¸ ê¸°ì¤€ì„ conversations â†’ scenarioRunsë¡œ ë°”ê¾¸ëŠ” ê²ƒì´ í•µì‹¬.


2. getUserScenarioRunsWithPersonaRunsë¥¼ ìœ„ ì½”ë“œì²˜ëŸ¼ ê³ ì¹˜ê³ ,


3. íˆìŠ¤í† ë¦¬ UIì—ì„œ ì´ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´
ê° ScenarioRunë‹¹ ì¹´ë“œ 1ê°œ + personaRuns ë°°ì—´ë¡œ í˜ë¥´ì†Œë‚˜ ì¹© ë Œë”ë§í•˜ë©´
ì§€ê¸ˆ ë§í•œ â€œë™ì¼ ì‹œë‚˜ë¦¬ì˜¤ 2íšŒì¸ë° 4ì¤„ ëœ¨ëŠ” ë¬¸ì œâ€ëŠ” ì‚¬ë¼ì§„ë‹¤.



ì›í•˜ë©´, í”„ë¡ íŠ¸ ìª½ ì»´í¬ë„ŒíŠ¸ (ì˜ˆ: React/Next) ì½”ë“œê¹Œì§€ ê°™ì´ ì§œ ì¤„ê²Œ.