이건 **Cloud Run에서 절대 되면 안 되는 호출**이 떠서 터지는 거야.

에러 핵심:

* 앱이 `http://127.0.0.1:1106/credential` 로 “크레덴셜”을 받으려고 함
* Cloud Run 컨테이너 안에는 그런 서버가 없으니 **ECONNREFUSED**
* 즉, 현재 스토리지/크레덴셜 로직이 **Replit(Object Storage) 전용 경로**를 타고 있어.

결론: **GCS를 쓰도록 코드 경로를 강제로 전환해야 하고, 그 전환을 가르는 env var(또는 런타임 감지)가 지금 Cloud Run에서 잘못 동작 중**이야.

---

## 1) 지금 무슨 일이 벌어졌냐 (정확히)

네 코드(또는 사용 중인 Object Storage 라이브러리)가 보통 이렇게 동작한다:

* `GCS_BUCKET_NAME`이 있으면 → Google Cloud Storage 사용
* 없으면 → Replit Object Storage 사용 (로컬 프록시 `127.0.0.1:1106`로 credential fetch)
* 둘 다 아니면 → “No storage backend available”

지금은 **GCS로 가야 하는데 Replit 경로를 타고 있음** → 그래서 127.0.0.1로 붙다가 터짐.

즉, 아래 중 하나다:

1. `GCS_BUCKET_NAME`이 Cloud Run에 실제로 안 들어갔다 (가장 흔함)
2. env var 이름이 코드에서 기대하는 것과 다르다
3. 값이 빈 문자열로 들어갔다
4. 컨테이너에 반영된 revision이 아닌 예전 revision을 보고 있다(드물지만 가능)

---

## 2) 바로 확인 (이거 먼저 실행)

Cloud Shell에서:

```bash
gcloud run services describe role \
  --region us-east1 \
  --format="yaml(spec.template.spec.containers[0].env)"
```

여기 결과에 **정확히** 아래가 보여야 정상:

* `name: GCS_BUCKET_NAME`
* `value: roleplay-bucket` (네 버킷명)

안 보이면 → **아직 설정 안 된 거**고, 보이는데도 계속 Replit로 가면 → 코드가 다른 키를 보고 있는 거.

---

## 3) 확실하게 세팅(한 번에 박제)

(예: 버킷이 roleplay-bucket, private prefix는 private 라고 가정)

```bash
gcloud run services update role \
  --region us-east1 \
  --update-env-vars GCS_BUCKET_NAME=roleplay-bucket \
  --update-env-vars PRIVATE_OBJECT_DIR=gs://roleplay-bucket/private
```

그리고 곧바로 다시 describe로 확인.

> `--set-env-vars` 대신 `--update-env-vars` 쓰는 이유: 기존 env를 날리는 실수를 방지.

---

## 4) 코드에서 “Replit 분기”를 Cloud Run에서 절대 타지 않게 막아라 (권장)

지금처럼 런타임 감지에 실패하면 또 재발한다. Cloud Run에서는 이런 식으로 가드 치는 게 안전해:

* `process.env.K_SERVICE` 또는 `process.env.K_REVISION` 있으면 → Cloud Run 환경
* Cloud Run이면 Replit credential fetch 로직 자체를 스킵하고, GCS env 없으면 바로 에러

의사코드:

```js
const isCloudRun = !!process.env.K_SERVICE;

if (isCloudRun) {
  if (!process.env.GCS_BUCKET_NAME) {
    throw new Error("GCS_BUCKET_NAME is required on Cloud Run.");
  }
  return useGCS(process.env.GCS_BUCKET_NAME);
}

// Replit fallback (only when not Cloud Run)
return useReplitObjectStorage();
```

---

## 5) (필수) 권한도 같이 확인

GCS로 전환되면 다음으로 흔히 터지는 게 권한이야. 이미 했을 수도 있지만 한 번에:

```bash
gcloud storage buckets add-iam-policy-binding gs://roleplay-bucket \
  --member="serviceAccount:runtime-sa@role-20260129.iam.gserviceaccount.com" \
  --role="roles/storage.objectAdmin"
```

---

## 6) 네 로그 상황에서 “가장 가능성 높은 1번”은 이거

**Cloud Run에 `GCS_BUCKET_NAME`이 실제로 반영이 안 됐거나(혹은 다른 서비스/리비전에 반영), 앱이 빈 값으로 보고 있어서 Replit 경로로 떨어진 것.**

---

### 다음 액션

1. 위 `describe ... env` 결과를 그대로 복사해서 붙여줘. (민감하면 value만 가려도 됨. key는 필요)
2. 동시에 `gcloud run services list --region us-east1` 해서 서비스명이 진짜 `role` 맞는지도 확인.

그 두 개만 보면 “설정이 안 들어간 문제”인지 “코드가 다른 env를 보는 문제”인지 바로 찍어서 끝낼 수 있어.
