# Google Cloud Build ÏÑ§Ï†ï ÌååÏùº
# - Docker build -> Artifact Registry push -> Cloud Run deploy
# - ÏïàÏ†ïÏÑ± Í∞úÏÑ†: repo Î≥ÄÏàòÌôî / update-env-vars / update-secrets / allow-unauth ÏòµÏÖòÌôî / secret Î≤ÑÏ†Ñ Í≥†Ï†ï

substitutions:
  _SERVICE_NAME: 'role'                 # Cloud Run ÏÑúÎπÑÏä§ Ïù¥Î¶Ñ
  _REGION: 'us-east1'                   # Î∞∞Ìè¨ Î¶¨Ï†Ñ
  _AR_REPO: 'cloud-run-source-deploy'   # Artifact Registry Ï†ÄÏû•ÏÜå Ïù¥Î¶Ñ
  _MEMORY: '1Gi'                        # Î©îÎ™®Î¶¨ Ìï†Îãπ
  _CPU: '1'                             # CPU Ìï†Îãπ
  _MIN_INSTANCES: '0'                   # ÏµúÏÜå Ïù∏Ïä§ÌÑ¥Ïä§
  _MAX_INSTANCES: '10'                  # ÏµúÎåÄ Ïù∏Ïä§ÌÑ¥Ïä§
  _GCS_BUCKET_NAME: 'roleplay-bucket'   # GCS Î≤ÑÌÇ∑ Ïù¥Î¶Ñ
  _ALLOW_UNAUTH: 'true'                 # Í≥µÍ∞ú ÏÑúÎπÑÏä§ Ïó¨Î∂Ä (true/false)

  # Secret Manager Î≤ÑÏ†Ñ (ÌîÑÎ°úÏ†ùÌä∏Ïóê ÎßûÍ≤å Ï°∞Ï†ï)
  _JWT_SECRET_VER: '1'
  _DATABASE_URL_VER: '1'
  _GOOGLE_API_KEY_VER: '1'

steps:
  # Step 1: Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:latest'
      - '.'

  # Step 2: Artifact RegistryÏóê Ïù¥ÎØ∏ÏßÄ Ìë∏Ïãú
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}'

  # Step 3: Cloud RunÏóê Î∞∞Ìè¨
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'Deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail

        echo "üöÄ Deploying to Cloud Run..."
        echo "Service: ${_SERVICE_NAME}"
        echo "Region:  ${_REGION}"
        echo "Repo:    ${_AR_REPO}"
        echo "Image:   ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}"

        ALLOW_FLAG=""
        if [ "${_ALLOW_UNAUTH}" = "true" ]; then
          ALLOW_FLAG="--allow-unauthenticated"
        fi

        gcloud run deploy ${_SERVICE_NAME} \
          --image ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA} \
          --region ${_REGION} \
          --platform managed \
          ${ALLOW_FLAG} \
          --memory ${_MEMORY} \
          --cpu ${_CPU} \
          --min-instances ${_MIN_INSTANCES} \
          --max-instances ${_MAX_INSTANCES} \
          --port 8080 \
          --timeout 300 \
          --update-env-vars NODE_ENV=production,AI_PROVIDER=gemini,GCS_BUCKET_NAME=${_GCS_BUCKET_NAME} \
          --update-secrets JWT_SECRET=jwt-secret:${_JWT_SECRET_VER},DATABASE_URL=database-url:${_DATABASE_URL_VER},GOOGLE_API_KEY=google-api-key:${_GOOGLE_API_KEY_VER}

        echo "‚úÖ Deployment complete!"

        echo "üåê Service URL:"
        gcloud run services describe ${_SERVICE_NAME} \
          --region ${_REGION} \
          --format 'value(status.url)'

images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: '1200s'
