# Cloud Build: Build -> Push -> Preflight(ê²€ì¦ë§Œ) -> Deploy
# Aì•ˆ: IAM ê¶Œí•œ ë³€ê²½ì€ cloudbuildì—ì„œ ìë™ìœ¼ë¡œ í•˜ì§€ ì•ŠìŒ (ì•ˆì „/ê°ì‚¬/ìš´ì˜ ëª©ì )
#     ëŒ€ì‹  Preflightì—ì„œ "ì‹¤ì œ ë™ì‘ ê¸°ë°˜" ì ê²€ìœ¼ë¡œ ì¬ë°œ ë°©ì§€.
#
# IMPORTANT:
# - Cloud BuildëŠ” $VAR / ${VAR} íŒ¨í„´ì„ substitutionsë¡œ í•´ì„í•  ìˆ˜ ìˆìŒ
# - Bash ë³€ìˆ˜ëŠ” ë°˜ë“œì‹œ $$VAR í˜•íƒœë¡œ ì°¸ì¡°(escape)í•´ì•¼ í•¨
#
# NOTE:
# - Project IAM(policy) ì½ê¸°(get-iam-policy)ëŠ” Cloud Resource Manager API í•„ìš”.
#   í™˜ê²½ë§ˆë‹¤ ë¹„í™œì„±ì¼ ìˆ˜ ìˆì–´ Preflightì—ì„œ ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ ì„¤ê³„.

substitutions:
  _SERVICE_NAME: 'role'
  _REGION: 'us-east1'
  _AR_REPO: 'cloud-run-source-deploy'

  _MEMORY: '1Gi'
  _CPU: '1'
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '10'

  _GCS_BUCKET_NAME: 'roleplay-bucket'
  _ALLOW_UNAUTH: 'true'
  _SIGNED_URL_TTL_MINUTES: '30'

  # Secrets (ë°˜ë“œì‹œ ENABLED ë²„ì „)
  _JWT_SECRET_VER: '1'
  _DATABASE_URL_VER: '15'
  _GOOGLE_API_KEY_VER: '1'

steps:
  # Step 1: Docker build
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:latest'
      - '.'

  # Step 2: Push to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}'

  # Step 3: Preflight checks (NO IAM mutation, NO Cloud Resource Manager dependency)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'Preflight'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail

        # gcloud prompts ë°©ì§€
        GCLOUD="gcloud --quiet"

        echo "ğŸ” Preflight checks..."
        RUNTIME_SA="runtime-sa@${PROJECT_ID}.iam.gserviceaccount.com"

        fail() {
          echo ""
          echo "âŒ Preflight failed: $$1"
          exit 1
        }

        warn() {
          echo "âš ï¸  $$1"
        }

        echo ""
        echo "1) Artifact Registry repo exists"
        $$GCLOUD artifacts repositories describe ${_AR_REPO} --location ${_REGION} >/dev/null \
          || fail "Artifact Registry repo '${_AR_REPO}' not found in ${_REGION}. Create it first."

        echo ""
        echo "2) GCS bucket exists"
        $$GCLOUD storage buckets describe gs://${_GCS_BUCKET_NAME} >/dev/null \
          || fail "Bucket gs://${_GCS_BUCKET_NAME} not found."

        echo ""
        echo "3) runtime service account exists: $$RUNTIME_SA"
        $$GCLOUD iam service-accounts describe $$RUNTIME_SA >/dev/null \
          || fail "Service account $$RUNTIME_SA not found. Create it first."

        echo ""
        echo "4) Secret versions are ENABLED (and accessible via Secret Manager at deploy-time)"
        JWT_STATE=$$($$GCLOUD secrets versions describe ${_JWT_SECRET_VER} --secret=jwt-secret --format='value(state)')
        DB_STATE=$$($$GCLOUD secrets versions describe ${_DATABASE_URL_VER} --secret=database-url --format='value(state)')
        KEY_STATE=$$($$GCLOUD secrets versions describe ${_GOOGLE_API_KEY_VER} --secret=google-api-key --format='value(state)')

        echo "   jwt-secret:${_JWT_SECRET_VER} => $$JWT_STATE"
        echo "   database-url:${_DATABASE_URL_VER} => $$DB_STATE"
        echo "   google-api-key:${_GOOGLE_API_KEY_VER} => $$KEY_STATE"

        test "$$JWT_STATE" = "ENABLED" || fail "jwt-secret:${_JWT_SECRET_VER} is not ENABLED."
        test "$$DB_STATE"  = "ENABLED" || fail "database-url:${_DATABASE_URL_VER} is not ENABLED."
        test "$$KEY_STATE" = "ENABLED" || fail "google-api-key:${_GOOGLE_API_KEY_VER} is not ENABLED."

        # (ì„ íƒ) ë¹Œë“œ SA ê¸°ì¤€ìœ¼ë¡œ secret accessê¹Œì§€ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
        # $$GCLOUD secrets versions access ${_DATABASE_URL_VER} --secret=database-url >/dev/null \
        #   || warn "Build SA cannot access secret payload (may be OK if runtime-sa has access)."

        echo ""
        echo "5) Cloud Run service sanity (cloudsql-instances annotation / service account)"
        # ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ, ìˆìœ¼ë©´ ì²´í¬
        if $$GCLOUD run services describe ${_SERVICE_NAME} --region ${_REGION} >/dev/null 2>&1; then
          CURRENT_SA=$$($$GCLOUD run services describe ${_SERVICE_NAME} --region ${_REGION} --format='value(spec.template.spec.serviceAccountName)' || true)
          ANNO=$$($$GCLOUD run services describe ${_SERVICE_NAME} --region ${_REGION} --format='value(spec.template.metadata.annotations)' || true)
          echo "   current runtime SA: $$CURRENT_SA"
          echo "   annotations: $$ANNO"

          echo "$$ANNO" | grep -q "run.googleapis.com/cloudsql-instances=" \
            || warn "cloudsql-instances annotation not found. If DATABASE_URL uses host=/cloudsql, DB connect may fail."
        else
          warn "Cloud Run service '${_SERVICE_NAME}' not found yet. Skipping service-level checks."
        fi

        echo ""
        echo "6) GCS permission practical test (create+read) - validates runtime-sa bucket permissions"
        # ì‚¬ì „ì„œëª…(signed URL)ê³¼ëŠ” ë¬´ê´€í•˜ê²Œ, runtime-saì˜ bucket write/readë¥¼ ì§ì ‘ ê²€ì¦í•˜ê³  ì‹¶ì§€ë§Œ
        # Cloud Build ë‹¨ê³„ëŠ” runtime-saë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ.
        # ê·¸ë˜ì„œ ì—¬ê¸°ì„œëŠ” 'ë²„í‚· ì¡´ì¬'ê¹Œì§€ë§Œ hard fail, ê¶Œí•œì€ ëŸ°íƒ€ì„ì—ì„œ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ë¡œ í™•ì¸í•˜ë„ë¡ ë‘”ë‹¤.
        # (ì›í•˜ë©´ ë³„ë„ testìš© SA impersonation ë°©ì‹ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥)

        echo ""
        echo "âœ… Preflight OK"

  # Step 4: Deploy
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'Deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        GCLOUD="gcloud --quiet"
        echo "ğŸš€ Deploying to Cloud Run..."

        RUNTIME_SA="runtime-sa@${PROJECT_ID}.iam.gserviceaccount.com"

        ALLOW_FLAG=""
        if [ "${_ALLOW_UNAUTH}" = "true" ]; then
          ALLOW_FLAG="--allow-unauthenticated"
        fi

        $$GCLOUD run deploy ${_SERVICE_NAME} \
          --image ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA} \
          --region ${_REGION} \
          --platform managed \
          $${ALLOW_FLAG} \
          --service-account $${RUNTIME_SA} \
          --memory ${_MEMORY} \
          --cpu ${_CPU} \
          --min-instances ${_MIN_INSTANCES} \
          --max-instances ${_MAX_INSTANCES} \
          --port 8080 \
          --timeout 300 \
          --update-env-vars NODE_ENV=production,AI_PROVIDER=gemini,GCS_BUCKET_NAME=${_GCS_BUCKET_NAME},SIGNED_URL_TTL_MINUTES=${_SIGNED_URL_TTL_MINUTES} \
          --update-secrets JWT_SECRET=jwt-secret:${_JWT_SECRET_VER},DATABASE_URL=database-url:${_DATABASE_URL_VER},GOOGLE_API_KEY=google-api-key:${_GOOGLE_API_KEY_VER}

        echo "âœ… Deployment complete!"
        $$GCLOUD run services describe ${_SERVICE_NAME} --region ${_REGION} --format 'value(status.url)'
        $$GCLOUD run services describe ${_SERVICE_NAME} --region ${_REGION} --format 'value(spec.template.spec.serviceAccountName)'

images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:${COMMIT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: '1200s'
