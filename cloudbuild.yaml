# Google Cloud Build ì„¤ì • íŒŒì¼
# 
# ì²« ë°°í¬ ì „ í•„ìˆ˜ ì„¤ì •:
# 1. ì•„ë˜ substitutions ì„¹ì…˜ì˜ ê°’ë“¤ì„ ì‹¤ì œ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”
# 2. Secret Managerì— í•„ìˆ˜ ì‹œí¬ë¦¿ì„ ìƒì„±í•˜ì„¸ìš” (./scripts/setup-cloud-run-env.sh ì‚¬ìš©)
# 3. Artifact Registry ì €ì¥ì†Œë¥¼ ìƒì„±í•˜ì„¸ìš”:
#    gcloud artifacts repositories create cloud-run-source-deploy \
#      --repository-format=docker \
#      --location=${_REGION} \
#      --project=${PROJECT_ID}
#
# ë°°í¬ ëª…ë ¹ì–´:
#   gcloud builds submit --config=cloudbuild.yaml .

substitutions:
  _SERVICE_NAME: 'role'                 # Cloud Run ì„œë¹„ìŠ¤ ì´ë¦„
  _REGION: 'us-east1'                   # ë°°í¬ ë¦¬ì „
  _MEMORY: '1Gi'                        # ë©”ëª¨ë¦¬ í• ë‹¹
  _CPU: '1'                             # CPU í• ë‹¹
  _MIN_INSTANCES: '0'                   # ìµœì†Œ ì¸ìŠ¤í„´ìŠ¤ (0 = ì½œë“œìŠ¤íƒ€íŠ¸ í—ˆìš©)
  _MAX_INSTANCES: '10'                  # ìµœëŒ€ ì¸ìŠ¤í„´ìŠ¤
  _GCS_BUCKET_NAME: 'roleplay-bucket'   # GCS ë²„í‚· ì´ë¦„ (ì´ë¯¸ì§€/ë¹„ë””ì˜¤ ì €ì¥ìš©)

steps:
  # Step 1: Docker ì´ë¯¸ì§€ ë¹Œë“œ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:latest'
      - '.'

  # Step 2: Artifact Registryì— ì´ë¯¸ì§€ í‘¸ì‹œ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}'

  # Step 3: Cloud Runì— ë°°í¬
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'Deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        echo "ğŸš€ Deploying to Cloud Run..."
        
        gcloud run deploy ${_SERVICE_NAME} \
          --image ${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:${COMMIT_SHA} \
          --region ${_REGION} \
          --platform managed \
          --allow-unauthenticated \
          --memory ${_MEMORY} \
          --cpu ${_CPU} \
          --min-instances ${_MIN_INSTANCES} \
          --max-instances ${_MAX_INSTANCES} \
          --port 8080 \
          --timeout 300 \
          --set-env-vars NODE_ENV=production,AI_PROVIDER=gemini,GCS_BUCKET_NAME=${_GCS_BUCKET_NAME} \
          --set-secrets JWT_SECRET=jwt-secret:latest,DATABASE_URL=database-url:latest,GOOGLE_API_KEY=google-api-key:latest
        
        echo "âœ… Deployment complete!"
        
        # ë°°í¬ëœ ì„œë¹„ìŠ¤ URL ì¶œë ¥
        gcloud run services describe ${_SERVICE_NAME} \
          --region ${_REGION} \
          --format 'value(status.url)'

images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:${COMMIT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: '1200s'
